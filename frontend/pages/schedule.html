<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Schedule Planner</title>
  <link rel="stylesheet" href="../index.css" />
  <style>
    .tabs button.active { font-weight: bold; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    #plannerGrid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 2px; }
    #plannerGrid .slot { border: 1px solid #ccc; height: 40px; }
  </style>
</head>
<body>
  <h2>Schedule Planner</h2>
  <div id="scheduleStats">
    <h3>Daily Stats</h3>
    <input type="number" id="statsUserId" placeholder="User ID" />
    <input type="date" id="statsDate" />
    <button id="statsBtn">Load</button>
    <span id="statsOutput"></span>
  </div>
  <div id="scheduleHistory">
    <h3>Schedule History</h3>
    <input type="date" id="historyDate" />
    <button id="historyBtn">Load</button>
    <ul id="historyList"></ul>
  </div>
  <div id="templateManager">
    <h3>Templates</h3>
    <input type="number" id="tmplUser" placeholder="User ID" />
    <input type="text" id="tmplDay" placeholder="Day of Week" />
    <input type="text" id="tmplName" placeholder="Template Name" />
    <button id="saveTemplateBtn">Save Default as Template</button>
    <br/>
    <select id="tmplSelect"></select>
    <input type="date" id="tmplDate" />
    <button id="applyTemplateBtn">Apply Template</button>
  </div>
  <div id="scheduleExport">
    <h3>Export Schedule</h3>
    <input type="number" id="exportUserId" placeholder="User ID" />
    <input type="date" id="exportDate" />
    <button id="exportBtn">Download ICS</button>
  </div>
  <div id="scheduleCopy">
    <h3>Copy Schedule</h3>
    <input type="number" id="copyUserId" placeholder="User ID" />
    <input type="date" id="copySrcDate" />
    <input type="date" id="copyDestStart" />
    <input type="date" id="copyDestEnd" />
    <button id="copyBtn">Copy</button>
  </div>
  <div id="scheduleAnalytics">
    <h3>Weekly Analytics</h3>
    <input type="number" id="analyticsUserId" placeholder="User ID" />
    <input type="date" id="analyticsWeek" />
    <button id="analyticsBtn">Load</button>
    <canvas id="categoryChart"></canvas>
    <canvas id="restChart"></canvas>
  </div>
  <div class="tabs">
    <button id="quickPlanTab" class="active">Quick Plan</button>
    <button id="advancedPlannerTab">Advanced Planner</button>
    <button id="bandPlanTab">Band Plan</button>
  </div>
  <div id="quickPlan" class="tab-content active"></div>
  <div id="advancedPlanner" class="tab-content"></div>
  <div id="bandPlan" class="tab-content">
    <h3>Band Plan</h3>
    <p>Propose a shared slot and vote with your bandmates.</p>
    <input type="date" id="bandDate" />
    <input type="number" id="bandSlot" min="0" max="95" placeholder="Slot" />
    <button id="proposeBtn">Propose</button>
    <ul id="proposals"></ul>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module" src="../components/scheduleAnalytics.js"></script>
  <script type="module" src="../components/quickPlan.js"></script>
  <script type="module" src="../components/advancedPlanner.js"></script>
  <script type="module" src="../components/scheduleStats.js"></script>
  <script>
    const quickTab = document.getElementById('quickPlanTab');
    const advTab = document.getElementById('advancedPlannerTab');
    const bandTab = document.getElementById('bandPlanTab');
    const quick = document.getElementById('quickPlan');
    const adv = document.getElementById('advancedPlanner');
    const band = document.getElementById('bandPlan');
    quickTab.addEventListener('click', () => {
      quickTab.classList.add('active');
      advTab.classList.remove('active');
      bandTab.classList.remove('active');
      quick.classList.add('active');
      adv.classList.remove('active');
      band.classList.remove('active');
    });
    advTab.addEventListener('click', () => {
      advTab.classList.add('active');
      quickTab.classList.remove('active');
      bandTab.classList.remove('active');
      adv.classList.add('active');
      quick.classList.remove('active');
      band.classList.remove('active');
    });
    bandTab.addEventListener('click', () => {
      bandTab.classList.add('active');
      quickTab.classList.remove('active');
      advTab.classList.remove('active');
      band.classList.add('active');
      quick.classList.remove('active');
      adv.classList.remove('active');
    });

    const proposals = document.getElementById('proposals');
    document.getElementById('proposeBtn').addEventListener('click', () => {
      const date = document.getElementById('bandDate').value;
      const slot = document.getElementById('bandSlot').value;
      if (!date || slot === '') return;
      const li = document.createElement('li');
      li.textContent = `${date} slot ${slot}`;
      li.dataset.votes = '0';
      const voteBtn = document.createElement('button');
      voteBtn.textContent = 'Vote';
      voteBtn.addEventListener('click', () => {
        li.dataset.votes = (parseInt(li.dataset.votes) + 1).toString();
        voteBtn.textContent = `Vote (${li.dataset.votes})`;
      });
      li.appendChild(voteBtn);
      proposals.appendChild(li);
    });

    document.getElementById('historyBtn').addEventListener('click', async () => {
      const date = document.getElementById('historyDate').value;
      if (!date) return;
      const res = await fetch(`/schedule/history/${date}`);
      const data = await res.json();
      const list = document.getElementById('historyList');
      list.innerHTML = '';
      for (const h of data.history) {
        const li = document.createElement('li');
        li.textContent = `slot ${h.slot}: ${JSON.stringify(h.before)} -> ${JSON.stringify(h.after)}`;
        list.appendChild(li);
      }
    });
    document.getElementById('exportBtn').addEventListener('click', () => {
      const userId = document.getElementById('exportUserId').value;
      const date = document.getElementById('exportDate').value;
      if (!userId || !date) return;
      window.location = `/schedule/export/ics?user_id=${userId}&date=${date}`;
    });

    document.getElementById('copyBtn').addEventListener('click', async () => {
      const uid = document.getElementById('copyUserId').value;
      const src = document.getElementById('copySrcDate').value;
      const start = document.getElementById('copyDestStart').value;
      const end = document.getElementById('copyDestEnd').value;
      if (!uid || !src || !start) return;
      const dates = [];
      let d = new Date(start);
      const endDate = end ? new Date(end) : new Date(start);
      while (d <= endDate) {
        dates.push(d.toISOString().slice(0,10));
        d.setDate(d.getDate() + 1);
      }
      await fetch('/schedule/copy', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({user_id: parseInt(uid), src_date: src, dest_dates: dates})
      });
    });

    const tmplSelect = document.getElementById('tmplSelect');
    async function loadTemplates() {
      const uid = document.getElementById('tmplUser').value;
      if (!uid) return;
      const res = await fetch(`/schedule/templates/${uid}`);
      const data = await res.json();
      tmplSelect.innerHTML = '';
      for (const t of data.templates) {
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = t.name;
        tmplSelect.appendChild(opt);
      }
    }
    document.getElementById('tmplUser').addEventListener('change', loadTemplates);

    document.getElementById('saveTemplateBtn').addEventListener('click', async () => {
      const uid = document.getElementById('tmplUser').value;
      const day = document.getElementById('tmplDay').value;
      const name = document.getElementById('tmplName').value;
      if (!uid || !day || !name) return;
      const res = await fetch(`/schedule/default-plan/${uid}/${day}`);
      const plan = await res.json();
      await fetch(`/schedule/templates/${uid}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name, entries: plan.plan})
      });
      await loadTemplates();
    });

    document.getElementById('applyTemplateBtn').addEventListener('click', async () => {
      const uid = document.getElementById('tmplUser').value;
      const date = document.getElementById('tmplDate').value;
      const tid = tmplSelect.value;
      if (!uid || !date || !tid) return;
      await fetch(`/schedule/apply-template/${uid}/${date}/${tid}`, {method: 'POST'});
    });
  </script>
  <script src="../components/themeToggle.js"></script>
</body>
</html>
