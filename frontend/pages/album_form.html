
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Album Form</title>
</head>
<body>
<script src="../utils/api.js"></script>
<div id="react-root"></div>
<h2>Create Release</h2>
<form id="albumForm">
  <input type="text" name="title" placeholder="Title" required />
  <select name="format">
    <option value="single">Single</option>
    <option value="ep">EP (max 4 tracks)</option>
    <option value="lp">LP</option>
  </select>
  <input type="text" name="genre" placeholder="Genre" required />
  <label>Select Tracks:</label>
  <div id="songSelector"></div>
  <label>Track Order:</label>
  <ul id="selectedTracks"></ul>
  <select name="distribution_channels" multiple>
    <option value="digital">Digital</option>
    <option value="vinyl">Vinyl</option>
    <option value="streaming">Streaming</option>
  </select>
  <input type="file" name="cover_art" />
  <img id="coverPreview" style="max-width:200px;display:none" alt="Cover Art Preview" />
  <button type="submit">Create Release</button>
</form>

<script src="../components/globalSearch.js"></script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script type="module" src="../dist/index.js"></script>
<script>
  const orderedTracks = [];
  const coverInput = document.querySelector('input[name="cover_art"]');
  const coverPreview = document.getElementById('coverPreview');

  function showCover(src) {
    if (src) {
      coverPreview.src = src;
      coverPreview.style.display = 'block';
    } else {
      coverPreview.style.display = 'none';
      coverPreview.removeAttribute('src');
    }
  }

  if (window.initialCoverArt) {
    showCover(window.initialCoverArt);
  }

  coverInput.addEventListener('change', function () {
    const file = coverInput.files[0];
    if (file) {
      showCover(URL.createObjectURL(file));
    } else if (window.initialCoverArt) {
      showCover(window.initialCoverArt);
    } else {
      showCover('');
    }
  });

  function renderTracks() {
    const list = document.getElementById('selectedTracks');
    list.innerHTML = '';
    orderedTracks.forEach((id, idx) => {
      const li = document.createElement('li');
      li.dataset.id = id;

      const up = document.createElement('button');
      up.type = 'button';
      up.textContent = '↑';
      up.onclick = () => {
        if (idx > 0) {
          [orderedTracks[idx - 1], orderedTracks[idx]] = [orderedTracks[idx], orderedTracks[idx - 1]];
          renderTracks();
        }
      };

      const down = document.createElement('button');
      down.type = 'button';
      down.textContent = '↓';
      down.onclick = () => {
        if (idx < orderedTracks.length - 1) {
          [orderedTracks[idx + 1], orderedTracks[idx]] = [orderedTracks[idx], orderedTracks[idx + 1]];
          renderTracks();
        }
      };

      const remove = document.createElement('button');
      remove.type = 'button';
      remove.textContent = '✖';
      remove.onclick = () => {
        orderedTracks.splice(idx, 1);
        const checkbox = document.querySelector(`#songSelector input[value="${id}"]`);
        if (checkbox) checkbox.checked = false;
        renderTracks();
      };

      li.append(up, down, remove);
      apiFetch(`/api/songs/${id}`)
        .then(r => r.json())
        .then(data => {
          li.append(` ${data.title || 'Song ' + id}`);
        })
        .catch(() => li.append(` Song ${id}`));
      list.appendChild(li);
    });
  }

  document.getElementById('songSelector').addEventListener('change', function(e) {
    if (e.target.type !== 'checkbox') return;
    const id = parseInt(e.target.value);
    if (e.target.checked) {
      orderedTracks.push(id);
    } else {
      const idx = orderedTracks.indexOf(id);
      if (idx >= 0) orderedTracks.splice(idx, 1);
    }
    renderTracks();
  });

  document.getElementById('albumForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const form = e.target;
    const tracks = orderedTracks.slice();
    const format = form.format.value;
    if (tracks.length === 0) {
      showNotification('Please select at least one track', 'error');
      return;
    }
    if (format === 'ep' && tracks.length > 4) {
      showNotification('EP releases can have at most 4 tracks', 'error');
      return;
    }
    const payload = {
      title: form.title.value.trim(),
      format,
      genre: form.genre.value.trim(),
      distribution_channels: Array.from(form.distribution_channels.selectedOptions).map(o => o.value),
      tracks
    };
    try {
      const res = await apiFetch('/api/albums', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (res.ok) {
        showNotification('Release created successfully', 'success');
        form.reset();
        orderedTracks.length = 0;
        renderTracks();
      } else {
        showNotification(data.message || data.error || 'Failed to create release', 'error');
      }
    } catch (err) {
      showNotification('Network error', 'error');
    }
  });
</script>
</body>
</html>
