<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Popularity Dashboard</title>
</head>
<body>
<h2>Song Popularity Dashboard</h2>

<div>
  <label for="songId">Song ID:</label>
  <input type="text" id="songId" />
  <button onclick="loadPopularity()">Load</button>
</div>

<div>
  Current Popularity: <span id="currentPopularity">-</span><br />
  Half-life (days): <span id="halfLife">-</span><br />
  Last Boost Source: <span id="lastBoost">-</span><br />
  Current Sentiment: <span id="currentSentiment">-</span>
</div>

<ul id="popularityHistory"></ul>
<h3>Sentiment History</h3>
<ul id="sentimentHistory"></ul>
<h3>Sentiment vs Popularity</h3>
<canvas id="trendChart" width="400" height="200"></canvas>
<h3>Forecast</h3>
<ul id="forecast"></ul>

<h3>World Pulse Top Genres</h3>
<button onclick="loadWorldPulse()">Refresh Snapshot</button>
<ul id="worldPulse"></ul>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
async function loadPopularity() {
  const id = document.getElementById('songId').value;
  const res = await fetch(`/music/metrics/songs/${id}/popularity`);
  const data = await res.json();
  document.getElementById('currentPopularity').innerText = data.current_popularity;
  document.getElementById('halfLife').innerText = data.half_life_days.toFixed(2);
  document.getElementById('lastBoost').innerText = data.last_boost_source || '-';
  const list = document.getElementById('popularityHistory');
  list.innerHTML = '';
  data.history.forEach(point => {
    const li = document.createElement('li');
    li.innerText = `${point.updated_at}: ${point.popularity_score}`;
    list.appendChild(li);
  });

  const sRes = await fetch(`/music/metrics/songs/${id}/sentiment`);
  const sData = await sRes.json();
  document.getElementById('currentSentiment').innerText = sData.current_sentiment.toFixed(2);
  const sList = document.getElementById('sentimentHistory');
  sList.innerHTML = '';
  sData.history.forEach(point => {
    const li = document.createElement('li');
    li.innerText = `${point.captured_at}: ${point.sentiment}`;
    sList.appendChild(li);
  });

  renderTrendChart(data.history, sData.history);

  const fRes = await fetch(`/music/metrics/songs/${id}/forecast`);

  // Hooks for custom chart rendering if available
  const fData = await fRes.json();
  const fList = document.getElementById('forecast');
  fList.innerHTML = '';
  fData.forecast.forEach(f => {
    const li = document.createElement('li');
    li.innerText = `${f.forecast_date}: ${f.predicted_score.toFixed(2)} (${f.confidence_interval[0].toFixed(2)} - ${f.confidence_interval[1].toFixed(2)})`;
    fList.appendChild(li);
  });
  // Hook for custom chart rendering if available
  if (window.renderPopularityChart) {
    window.renderPopularityChart(data.history);
  }
  if (window.renderSentimentChart) {
    window.renderSentimentChart(sData.history);
  }
}

async function loadWorldPulse() {
  const today = new Date().toISOString().slice(0, 10);
  const res = await fetch(`/api/world-pulse/ranked?date=${today}&limit=10`);
  const data = await res.json();
  const list = document.getElementById('worldPulse');
  list.innerHTML = '';
  data.forEach(row => {
    const li = document.createElement('li');
    li.innerText = `${row.rank}. ${row.genre} (${row.score}) ${row.trend_emoji}`;
    list.appendChild(li);
  });
}

let trendChart = null;
function renderTrendChart(popularityHistory, sentimentHistory) {
  const times = Array.from(new Set([
    ...popularityHistory.map(p => p.updated_at),
    ...sentimentHistory.map(s => s.captured_at),
  ])).sort();
  const popMap = new Map(popularityHistory.map(p => [p.updated_at, p.popularity_score]));
  const sentMap = new Map(sentimentHistory.map(s => [s.captured_at, s.sentiment]));
  const popData = times.map(t => popMap.get(t) ?? null);
  const sentData = times.map(t => sentMap.get(t) ?? null);
  const ctx = document.getElementById('trendChart').getContext('2d');
  if (trendChart) trendChart.destroy();
  trendChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: times,
      datasets: [
        { label: 'Popularity', data: popData, yAxisID: 'y1', borderColor: 'blue', fill: false },
        { label: 'Sentiment', data: sentData, yAxisID: 'y2', borderColor: 'red', fill: false },
      ],
    },
    options: {
      scales: {
        y1: { type: 'linear', position: 'left', title: { display: true, text: 'Popularity' } },
        y2: { type: 'linear', position: 'right', title: { display: true, text: 'Sentiment' } },
      },
    },
  });
}
</script>
</body>
</html>
