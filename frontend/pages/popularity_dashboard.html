<h2>Song Popularity Dashboard</h2>

<div>
  <label for="songId">Song ID:</label>
  <input type="text" id="songId" />
  <button onclick="loadPopularity()">Load</button>
</div>

<div>
  Current Popularity: <span id="currentPopularity">-</span><br />
  Half-life (days): <span id="halfLife">-</span><br />
  Last Boost Source: <span id="lastBoost">-</span><br />
  Current Sentiment: <span id="currentSentiment">-</span>
</div>

<ul id="popularityHistory"></ul>
<h3>Sentiment History</h3>
<ul id="sentimentHistory"></ul>
<h3>Forecast</h3>
<ul id="forecast"></ul>

<script>
async function loadPopularity() {
  const id = document.getElementById('songId').value;
  const res = await fetch(`/music/metrics/songs/${id}/popularity`);
  const data = await res.json();
  document.getElementById('currentPopularity').innerText = data.current_popularity;
  document.getElementById('halfLife').innerText = data.half_life_days.toFixed(2);
  document.getElementById('lastBoost').innerText = data.last_boost_source || '-';
  const list = document.getElementById('popularityHistory');
  list.innerHTML = '';
  data.history.forEach(point => {
    const li = document.createElement('li');
    li.innerText = `${point.updated_at}: ${point.popularity_score}`;
    list.appendChild(li);
  });

  const sRes = await fetch(`/music/metrics/songs/${id}/sentiment`);
  const sData = await sRes.json();
  document.getElementById('currentSentiment').innerText = sData.current_sentiment.toFixed(2);
  const sList = document.getElementById('sentimentHistory');
  sList.innerHTML = '';
  sData.history.forEach(point => {
    const li = document.createElement('li');
    li.innerText = `${point.captured_at}: ${point.sentiment}`;
    sList.appendChild(li);
  });
  // Hooks for custom chart rendering if available
  const fRes = await fetch(`/songs/${id}/forecast`);
  const fData = await fRes.json();
  const fList = document.getElementById('forecast');
  fList.innerHTML = '';
  fData.forecast.forEach(f => {
    const li = document.createElement('li');
    li.innerText = `${f.forecast_date}: ${f.predicted_score.toFixed(2)} (${f.confidence_interval[0].toFixed(2)} - ${f.confidence_interval[1].toFixed(2)})`;
    fList.appendChild(li);
  });
  // Hook for custom chart rendering if available
  if (window.renderPopularityChart) {
    window.renderPopularityChart(data.history);
  }
  if (window.renderSentimentChart) {
    window.renderSentimentChart(sData.history);
  }
}
</script>

