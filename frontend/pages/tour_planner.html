
<h2>Tour Planner</h2>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-sA+e8oqJ7uwVB1Cifj8P6R9iW/tSti7ouemZoDUopkw="
  crossorigin=""
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-o9N1j7UwyZwLRyy1A8kz7VF8NjFsg6z2g52n8TbNLD0="
  crossorigin=""
></script>

<form id="tourForm">
  <input type="text" name="title" placeholder="Tour Name" required />
  <input type="text" name="band_id" placeholder="Band ID" required />
  <input type="text" name="start_date" placeholder="Start Date (YYYY-MM-DD)" required />
  <input type="text" name="end_date" placeholder="End Date (YYYY-MM-DD)" required />
  <input type="text" name="vehicle_type" placeholder="Vehicle (van, bus, truck, plane)" required />
  <div id="map" style="height: 400px; margin-top: 10px;"></div>
  <p id="selectedCities" style="margin-top: 10px;"></p>
  <button type="submit">Plan Tour</button>
</form>

<div id="itinerary"></div>

<script>
const cities = {
  "New York": [40.7128, -74.006],
  "Los Angeles": [34.0522, -118.2437],
  "Chicago": [41.8781, -87.6298],
  "Houston": [29.7604, -95.3698],
  "Phoenix": [33.4484, -112.074]
};

const map = L.map('map').setView([39.5, -98.35], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

const route = [];
Object.entries(cities).forEach(([name, coords]) => {
  const marker = L.marker(coords).addTo(map).bindPopup(name);
  marker.on('click', () => {
    if (!route.includes(name)) {
      route.push(name);
      document.getElementById('selectedCities').innerText = route.join(' -> ');
    }
  });
});

document.getElementById('tourForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  if (route.length < 2) {
    alert('Select at least two cities.');
    return;
  }
  if (new Set(route).size !== route.length) {
    alert('Duplicate cities in route.');
    return;
  }

  const formData = new FormData(e.target);
  const payload = {
    title: formData.get('title'),
    band_id: parseInt(formData.get('band_id')),
    start_date: formData.get('start_date'),
    end_date: formData.get('end_date'),
    vehicle_type: formData.get('vehicle_type'),
    route: route
  };

  const res = await fetch('/api/tour-planner/optimize', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  const result = await res.json();
  const quotaRes = await fetch(`/api/bands/${payload.band_id}/recording-slots`);
  const { remaining_slots } = await quotaRes.json();
  const itineraryDiv = document.getElementById('itinerary');
  let remainingSlots = remaining_slots;
  itineraryDiv.innerHTML = `
    <h3>Optimized Itinerary</h3>
    <p id="recordSlots">Recording slots remaining: ${remainingSlots}</p>
    <ul id="itineraryList">
      ${result.itinerary
        .map(
          (city, idx) =>
            `<li><label><input type="checkbox" data-idx="${idx}"> ${city}</label></li>`
        )
        .join('')}
    </ul>
    <p>Total Distance: ${result.total_distance.toFixed(2)} km</p>
    <p>Total Time: ${result.total_time.toFixed(2)} hrs</p>
    <p>Estimated Cost: $${result.total_cost.toFixed(2)}</p>
    <button type="button" id="saveRecordings">Save Recording Choices</button>
  `;

  const updateSlots = () => {
    document.getElementById('recordSlots').innerText = `Recording slots remaining: ${remainingSlots}`;
    document
      .querySelectorAll('#itineraryList input[type="checkbox"]')
      .forEach((cb) => {
        if (!cb.checked) {
          cb.disabled = remainingSlots <= 0;
        }
      });
  };

  document
    .querySelectorAll('#itineraryList input[type="checkbox"]')
    .forEach((cb) => {
      cb.addEventListener('change', () => {
        remainingSlots += cb.checked ? -1 : 1;
        updateSlots();
      });
    });
  updateSlots();

  document.getElementById('saveRecordings').addEventListener('click', async () => {
    const recordStops = Array.from(
      document.querySelectorAll('#itineraryList input[type="checkbox"]')
    )
      .filter((cb) => cb.checked)
      .map((cb) => parseInt(cb.dataset.idx));
    await fetch('/api/tour-planner/schedule/update', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ updates: recordStops.map((id) => ({ stop_id: id, is_recorded: true })) }),
    });
    alert('Recording preferences saved');
  });
});
</script>
