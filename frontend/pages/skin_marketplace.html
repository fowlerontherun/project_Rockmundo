<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Skin Marketplace</title>
  </head>
  <body>
    <h1>Skin Marketplace</h1>
    <form id="uploadForm">
      <input name="name" placeholder="Name" required />
      <input name="category" placeholder="Category" required />
      <input name="rarity" placeholder="Rarity" required />
      <input name="author" placeholder="Author" required />
      <input name="price" type="number" placeholder="Price" required />
      Mesh: <input type="file" name="mesh" required />
      Texture: <input type="file" name="texture" required />
      <button type="submit">Upload Skin</button>
    </form>

    <ul id="skinList"></ul>

    <script>
      const avatarId = 1; // demo avatar id

      function toBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      document.getElementById('uploadForm').onsubmit = async (e) => {
        e.preventDefault();
        const form = e.target;
        const payload = {
          name: form.name.value,
          category: form.category.value,
          rarity: form.rarity.value,
          author: form.author.value,
          price: Number(form.price.value),
          mesh_b64: await toBase64(form.mesh.files[0]),
          texture_b64: await toBase64(form.texture.files[0]),
        };
        await fetch('/api/skins/upload', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        form.reset();
        loadSkins();
      };

      async function loadSkins() {
        const res = await fetch('/api/skins');
        const skins = await res.json();
        const list = document.getElementById('skinList');
        list.innerHTML = '';
        skins.forEach((skin) => {
          const item = document.createElement('li');
          item.textContent = `${skin.name} - ${skin.price}`;
          const btn = document.createElement('button');
          btn.textContent = 'Buy';
          btn.onclick = async () => {
            await fetch(`/api/skins/${skin.id}/purchase`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ avatar_id: avatarId }),
            });
            alert('Purchased ' + skin.name);
          };
          item.appendChild(btn);
          list.appendChild(item);
        });
      }

      loadSkins();
    </script>
  </body>
</html>

