<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Media Mentions</title>
</head>
<body>
<script src="../utils/api.js"></script>
<h2>Media Mentions Monitor</h2>
<button onclick="pollFeed()">Poll Media Feed</button>
<ul id="mentions"></ul>
<div>
  <h3>Manual Adjustment</h3>
  <label>Song ID <input type="number" id="adjSong" /></label>
  <label>Amount <input type="number" id="adjAmount" /></label>
  <label>Details <input type="text" id="adjDetails" /></label>
  <button onclick="sendAdjust()">Apply</button>
</div>
<canvas id="impactChart" width="400" height="200"></canvas>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
async function loadMentions() {
  const res = await apiFetch('/api/song-popularity/events?source=media');
  const data = await res.json();
  const list = document.getElementById('mentions');
  list.innerHTML = '';
  data.events.forEach(evt => {
    const li = document.createElement('li');
    li.textContent = `#${evt.id} Song ${evt.song_id} (+${evt.boost}) ${evt.details || ''}`;
    li.onclick = () => showImpact(evt.song_id);
    list.appendChild(li);
  });
}
async function pollFeed() {
  await apiFetch('/api/song-popularity/media/poll', {method: 'POST'});
  loadMentions();
}
async function showImpact(songId) {
  const res = await apiFetch(`/music/metrics/songs/${songId}/popularity`);
  const data = await res.json();
  const labels = data.history.map(h => h.updated_at);
  const scores = data.history.map(h => h.popularity_score);
  const ctx = document.getElementById('impactChart').getContext('2d');
  if (window.impactChart) window.impactChart.destroy();
  window.impactChart = new Chart(ctx, {
    type: 'line',
    data: {labels: labels, datasets: [{label: 'Popularity', data: scores}]}
  });
}
async function sendAdjust() {
  const songId = parseInt(document.getElementById('adjSong').value);
  const amount = parseInt(document.getElementById('adjAmount').value);
  const details = document.getElementById('adjDetails').value;
  await apiFetch('/api/song-popularity/media/adjust', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({song_id: songId, amount: amount, details: details})
  });
  loadMentions();
}
loadMentions();
</script>
</body>
</html>
