name: Preflight ‚Äî Startup Doctor

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - "**/*.py"
      - "backend/**"
      - "frontend/**"
      - ".env.example*"
      - ".github/workflows/ci-preflight.yml"
  push:
    branches: [ main ]
    paths:
      - "**/*.py"
      - "backend/**"
      - "frontend/**"
      - ".env.example*"
      - ".github/workflows/ci-preflight.yml"

jobs:
  preflight:
    name: Run Startup Doctor
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ‚öôÔ∏è Setup Node (for version checks)
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: üì¶ Install system deps (gettext for msgfmt)
        run: |
          sudo apt-get update
          sudo apt-get install -y gettext

      - name: üîß Install Python deps (best-effort)
        run: |
          if [ -f requirements.txt ]; then
            python -m pip install --upgrade pip
            pip install -r requirements.txt
          else
            echo "No requirements.txt found ‚Äî continuing."
          fi

      - name: ü©∫ Run Startup Doctor (read-only)
        run: |
          set -o pipefail
          python rockmundo_startup_doctor.py 2>&1 | tee doctor.log

      - name: ‚¨ÜÔ∏è Upload Doctor log (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: startup-doctor-log
          path: doctor.log
